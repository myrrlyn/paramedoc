# Paramedoc Controls

Some text in a Paramedoc document exists only to operate the document engine,
and is not part of the display. Link definitions are one such control, but the
primary structure is derived from the Kramdown IAL.

## Grammar

An IAL is similar to a Python or Rust format string: it is an open and close
curly brace, separated by a colon, `{:}`. It _may_ have one HTML tag name to the
left of the colon, `{tag:}`, and it _may_ have zero or more HTML attributes to
the right of the colon, `{:name="value"}`, each separated by a space.

There **must not** be a space between the opening brace and the tag name, the
tag name and the colon, the colon and the first attribute, or the last attribute
and the closing brace. If the tag name is empty, then the opening brace and
colon must be directly adjacent; if there are no attributes, then the colon and
closing brace must be directly adjacent. The only spaces permitted are between
successive attributes, or within a double-quoted value.

### Tag Names

Any text between the opening brace and the colon is taken to be an HTML tag
name. The name does not have to be one of the known tags, as the receiving
document may define additional tags. If the name is not a well-formed HTML
identifier, then the output document is ill-formed, but this is not a Paramedoc
error.

The tag name may not contain whitespace. As an exception, if the IAL is being
applied to a Paramedoc structure which produces two tag layers (see below), then
two tag names, separated by a space, may be provided. The first applies to the
outer tag, the second to the inner tag(s), and the attributes to the outer.

### Attribute Values

The basic attribute syntax is `{key}="{value}"`. The value does not need to be
double-quoted, and may be a bare word. The value, and the preceding `=`, may be
elided. For convenience, the CSS patterns `#ident` and `.classname` expand to
the HTML attributes `id="ident"` and `class="classname"`, respectively. Multiple
`.class .kind` shortcuts may be present in an IAL, in which case they are joined
by whitespace: `class="class kind"`.

## Purpose

An IAL attaches to the preceding element in the document, and applies its HTML
transforms to that element. The tag name rewrites the preceding HTML tag, and
the attributes attach to it. On conflict, the IAL attributes override any that
are automatically generated by the HTML engine. For example, heading elements
automatically generate an `id` attribute, but the `{:#ident}` IAL replaces that
attribute with the specified `id="ident"`.

Any HTML element which does not have dedicated Paramedoc syntax can be produced
by creating an element of the appropriate kind, block or flow, then attaching a
tag-overwriting IAL to it.

## Attachment Logic

IALs attach to the most-immediately-recent HTML node, which can be text, the
opening tag of an element, *or the closing tag*. This can be useful for
Paramedoc constructs which create two tag layers, such as the
`<ol><li>`/`<ul><li>` lists, or `<pre><code>` and `<pre><samp>` code blocks.

## Examples

- `{:}`: the empty IAL does nothing, but it interrupts the parser and prevents
  it from joining twin siblings. In flow context, `</{name}><{name}>` close/open
  pairs get automatically deleted, so `*a* *b*` becomes `<em>a b</em>`. However,
  the empty IAL between them `*a* {:} *b*` separates the elements, allowing
  `<em>a</em> <em>b</em>` to exist.

- In a run of ordinary text, the IAL attaches to the previous text run. If the
  run does not have an element, it is wrapped in a `<span>`.

  ```pmd
  This paragraph text {:.one} gets wrapped in a span.
  *This* {:.two} emphasized text does not.
  ```

  ```html
  <p>
    <span class="one">This paragraph text</span> gets wrapped in a span.
    <em class="two">This</em> emphasized text does not.
  </p>
  ```

- When an IAL has no predecessor in its block, it attaches to the innermost
  enclosing node. When an IAL comes after a run of closing tags, it attaches to
  the outermost of its predecessors.

  ```pmd
  1. This list item is unchanged
  1. {:value=0} This list item has its number re-assigned.
  1. The entire list is modified by the next IAL.

  {:reversed}
  ```

  ```html
  <ol reversed>
    <li>This list item is unchanged.</li>
    <li value="0">This list item has its number re-assigned.</li>
    <li>The entire list is modified by the next IAL.</li>
  </ol>
  ```

- A list may be rewritten using a two-layer outer IAL, allowing simplification
  of, e.g., many `<source>` elements in a `<picture>`:

  ```pmd
  - {:src="/one.jpg" type="image/jpeg"}
  - {:src="/two.tiff" type="image/tiff"}

  {picture source:}
  ```

  ```html
  <picture>
    <source src="/one.jpg" type="image/jpeg" />
    <source src="/two.tiff" type="image/tiff" />
  </picture>
  ```

  The `{:src ...}` IALs attached only to their respective `<li>`, but the
  `{picture source:}` IAL changed the `<ul>` to `<picture>`, and _every_ child
  `<li>` to `<source>`.

- Custom HTML can be written by creating an empty block, `>`, or flow, `<>`,
  then attaching an IAL to it:

  ```pmd
  > {textarea:}
  ```

  ```html
  <textarea></textarea>
  ```

  ```pmd
  <> {audio:controls src="/music.mp3"}
  ```

  ```html
  <audio controls src="/music.mp3"></audio>
  ```

- The only exception to the rule that IALs always modify the previous HTML node
  is if they contain a tag name known to be one of the [void elements], such as
  `<br>`

  ```pmd
  Even with this text, {br:}
  Void tags do not hold content {br:}
  And become themselves
  ```

  ```html
  <p>Even with this text,<br />Void tags do not hold content<br />And
  become themselves</p>
  ```

[void elements]: https://developer.mozilla.org/en-US/docs/Glossary/Void_element
